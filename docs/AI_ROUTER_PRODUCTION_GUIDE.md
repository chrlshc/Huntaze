 ! 🚀**
uctionodt pour la pr---

**Prêe

acieusation grur dégradlbacks poal[ ] Fontexte
- urés avec cct Logs struées
- [ ]gurfi cons et alertess défini[ ] SLO
- hit ratee  caches detriqu] Mévé
- [ ng actietry tracilem] OpenTe [ ques
-itiendpoints crkeys sur ncy mpote] Ide[ N strict
- uts pour JSOoutptured 
- [ ] Strucsage: true`include_uming avec `
- [ ] Streater jit +ackoffvec bimiting a[ ] Rate lmonitoré
-  et uréaker configCircuit bre

- [ ] ctioncklist Produ
## ✅ Che


----llm-apis/)ngstreami/2024/Aug/8/ison.netsimonwill(https://ison] WillPIs - SimonM AStreaming LLles
- [tic/)

### Ars/jsgenguacs/lao/dontelemetry.i/opettps:/Telemetry](h- [Openeader)
y-key-hempotenchttpapi-idietf-t-c/html/draftf.org/do.ieatatrackerhttps://d)](ader (IETF Hey-Keyncmpote [Ide
-andards# St

##g)-cachinptprom-to/i/how/openaervices-sre/aiom/en-us/azu.cftn.microso//learps:(htt4 tokens)]02aching (≥1 Crompt
- [Pa)-to/quots/openai/how/ai-service/en-us/azurecrosoft.comarn.mi/lettps:/rs](himit Heade
- [Rate Lreaker)t-bns/circuicture/patter/architeen-us/azurerosoft.com/n.micear://ltpsattern](hteaker Puit Brure
- [Circ
### Azs/batch)
m/docs/guidepenai.coorm.os://platftph API](ht[Batc- tputs)
ructured-ous/guides/sti.com/docpenarm.oplatfots](https://ed Outputur
- [Strucng)nce/streamiereapi-refm/docs/conai.opeorm.ps://platfg](htt- [Streaminte-limits)
es/radocs/guidnai.com/rm.ope//platfohttps:imits]( L [Rate)
-ngpt-cachiguides/promdocs/m/openai.com.//platforing](https:ompt CachI
- [Pr OpenA
###plètes
érences Com Réf-

## 📚

--```};
}
usage  content, urn { ret}
  }

 )}`);
    (4ed.15).toFix0) * 01_000_00okens / age.totalTusost: ~$${((`  Cg(nsole.lo);
      coxed(1)}%)`00).toFi* 1{(hitRate  0} ($ens ||hedToksage.cacached: ${ue.log(`  Cconsol
      ;s}`).totalToken: ${usagetal tokense.log(`  To    consolcs:`);
  📊 Metriog(`\n\n   console.l );

   
     ptTokenssage.prom      u  ,
kens || 0edTo usage.cach
       itRate(eCacheH= calculatitRate st h   con   
   e;
   usage = chunk.      usage') {
e === 'usagunk.typ if (chlse  } 
    eontent);
  ite(chunk.cut.wrstdos.oces;
      prntonte= chunk.content +      cnt') {
 === 'contepe.ty (chunk if  dy)) {
 at', boenai/ch/opletion('/apistreamComphunk of  (const c  for awaitny;

: a usageet = '';
  l content  let }
  };

_usage: true: { includeream_options   st
 rue,  stream: tmpt }],
  ntent: pro', co: 'user [{ rolesages: mes   ,
gpt-4o-mini'  model: '
   body = {st contring) {
 prompt: sing(nitormWithMorea function st
async;
advanced'router-ervices/ai- '@/lib/sromRate } feHitalculateCachompletion, camC stret {ript
impor``typescoring

` avec Monit: Streaminge 2### Exempl


``` }
}
 );  span.end(inally {
  
  } fw error;hro);
    t(error) }tring message: S({ code: 2,an.setStatusor);
    sperror as ErrrdException(   span.reco
 h (error) {;
  } catc resulturn

    retde: 1 }); cotStatus({n.ses);
    spaributes(attr span.setAtt  });

    0) > 0
  s ||_tokenhedcacns_details?..prompt_tokeult.usage (res   cacheHit:   tencyMs,
    la.state,
  etMetrics()ker.grcuitBreatAICi: defaulte circuitSta  : 0,
    retryCount
      0, ||ed_tokens?.cachlsns_detaipt_tokepromlt.usage. resuns:edToke  cach
    tion_tokens,lee.compusagesult.eTokens: r   respons,
   kense.prompt_tolt.usag: resuuestTokens,
      req.completion'atch 'tion:era op   
  ,sion.modeldel: deci
      moributes({eAISpanAtteat crt attrs =
    consme;- startTi() owte.nencyMs = Daonst lat c  etry
 nTelemec Operacer av   // 5. T);

     });
n(sponse.jso return re

     y
      } retr // TriggerEXCEEDED');T_ATE_LIMI Error('Rhrow new    t;
    epMs))solve, sleut(remeoetTisolve => sreew Promise(it n      awaaders);
  ponse.heep(resSleateLimitcomputeReepMs =  const sl       {
 tus === 429)se.sta (respon if
     ntntelligemme iiting rate lim. Gérer      // 4   });

       })
mpt }]
     pront:onte, cuser' [{ role: '   messages:  ,
     ision.model decodel:
          mify({stringdy: JSON.    bo    },
        otencyKey
 idempncy-Key':   'Idempote
       tion/json',lica-Type': 'appntent     'Co{
     :    headers   
  : 'POST',      method{
  at', ai/chpentch('/api/oait fee = aw respons      const);

all'yKey('ai-cncdempoteenerateI= gpotencyKey  idem constblons
      doupour éviterency key . Idempot // 3
     ync () => {te(asr.execuitBreakeAICircu defaultt = await resul    const
 storms retryr éviter breaker pou. Circuit 2
    //;
n}`)reasoion.isl}: ${decn.modeisiosing ${dec.log(`Uonsole;

    cium'
    })'medh:  outputLengt,
     cal: false  isCriti: 5,
    Scoreexity  compls any,
    pe ae: taskTy taskTypest({
     teAIRequon = rouconst decisiptimal
    le o le modèsir choi pourouter // 1. R  {
 try ();
  
  Date.now = startTimest );
  concall'd.ptimizen('ai.oer.startSpaspan = traconst -ai');
  c'huntazegetTracer(ace.cer = tronst tra{
  ce: string) ing, taskTypprompt: stredAICall(optimiztion 
async func
ry/api';lemetnteopem '@race } fro { t
importnced';router-advavices/ai-'@/lib/seres
} from utAISpanAttribreate c
 cyKey,dempoten generateIp,
 itSleeeLimomputeRat  ctBreaker,
rcuiaultAICi  deft { 

imporai-router';es/icerv '@/lib/sfrom} t ues{ routeAIReqimport escript
ns

```typatioles Optimisavec Toutes  Simple : Appelmple 1xe# Elets

##mples Comp🚀 Exe## 
---


```
;or()icsCollect new Metrctor =metricsColleconst export 
}

 };
  }
   ed(4)ests).toFixqutalReics.tos.metrlCost / thimetrics.totas.hit: (tstPerReques avgCo   '%',
   Fixed(1) +rcentage.totage: miniPeiPercenmin    '%',
  ed(1) + 100).toFixtRate * HiRate: (cache    cacheHits,
  tric.meis..th   .
   n {    retur

ests) * 100;alRequtothis.metrics./ tsts quecs.miniReetri= (this.mrcentage Peni   const mi   );

 s
 Tokenics.total  this.metr,
    ensdTokcs.cachetri     this.mete(
 acheHitRateC = calculacheHitRateonst ca    ct() {
etRepor  }

  g    }
ts++;
quess.fullReis.metric     th } else {
 sts++;
   .miniRequethis.metrics)) {
      'mini's(l.includemodeif ( 
    = cost;
   talCost +s.metrics.tohi t;
   cheds += caedTokenetrics.cachhis.m
    t tokens;+=alTokens .metrics.tot  thists++;
  totalRequesics.is.metr {
    thncy: number)tember, la: nucost number, cached:er, ns: numbtring, tokel: sRequest(modeord rec;

  }te: 0
 
    errorRaLatency: 0,    p95alCost: 0,
   tot0,
 kens: cachedTons: 0,
    Toke
    totals: 0,Request,
    fullsts: 0miniReque 0,
    equests:totalR    
 = {etricsetrics: AIMvate m
  priollector {s MetricsClasber;
}

cnumrorRate: r;
  erncy: numbeLatember;
  p95st: nualCo;
  toterns: numbkecachedTomber;
   nuTokens:talber;
  tos: numest
  fullRequ number;ts:niRequesmi
  number;equests: {
  totalRics ace AIMetr';

interfer-advancedi-rout/aices/lib/servfrom '@e } itRatacheHlateCalcu c
import {criptypeser

```ts à TrackiqueMétr``

### 
};
`  // USDt': 500    ost.targemonthly.c 'uêtes
 des req      // %          .usage': 85,  'mini/ Coûts

  
  /        // % 85,   te':.hit.racachehe
  '
  // Cac  // %
           99.9,y': abilitvaillité
  'aonibi// Disp 
  
 / ms500,      /cy': 2enfull.p95.lat ' ms
 //,      200ncy': 1ni.p95.latece
  'mi// Laten= {
  t SLOs cript
conspesés

```tyecommand# SLOs Roring

## Monit 📈 SLOs &

---

##ode)s-numentationuto-instrges/ackapan/metae/maitrib/treetry-js-contelem/openetrym/open-telem/github.co(https:/ Node]umentationto-instr/)
- [Auuages/jscs/langemetry.io/dopentelps://o](htty JSenTelemetrs:**
- [OpRéférence
**}
```
 }
.end();
   span
   finally {rror;
  }hrow e
    tROR ERor) }); //ring(err Stessage:code: 2, msetStatus({  span.ror);
    Ern(error asiordExceptreco  span. {
  atch (error)} c;
   response return
    
   ); // OK{ code: 1 }setStatus(an.  sprs);
  es(attutetAttrib
    span.s   });
|| 0) > 0
 ens hed_tokcacdetails?.okens_pt_tage.promesponse.useHit: (r cach   
  Ms,  latency',
    ate: 'CLOSEDcircuitSt
      yCount: 0,     retr,
 kenstohed_?.caclsdetaipt_tokens_sage.promonse.uns: respToke    cachedtokens,
  letion_compsage. response.uokens:seTponress,
      mpt_tokene.proesponse.usagTokens: rrequest     
 etion',at.compl 'chration:,
      opemini'pt-4o-'gmodel:     tes({
  ttribuateAISpanArest attrs = c  conI
  ibuts Ar les attroute/ Aj    /ime;
    
() - startTowe.nncyMs = Dat late
    const   });
 })
 mptfy({ pro.stringidy: JSON{
      boi/chat', '/api/aPICall( await makeAresponse =
    const  try {  
 w();
Date.noime = rtTconst sta);
  ion'letomp('ai.crtSpanr.statrace span = st  cong) {
: strinCall(promptn tracedAIfunctionc 

asy');e-aicer('huntaze.getTracer = tracnst traced';

codvanouter-aervices/ai-r@/lib/ss } from 'ributeeAISpanAttreatt { c
imporry/api';elemet'@opentce } from ort { trascript
imp

```type Routeravec AIn tiolisa
### Uti```
art();
);

sdk.sts()],
}ionInstrumentatetNodeAutoons: [gumentati instr
 eSDK({dk = new Nod
const snode';
tations-instrumen/auto-ryentelemet '@opromations } frumentNodeAutoInst{ get;
import ry/sdk-node'ntelemet} from '@opet { NodeSDK on.ts
imporatirumentt
// insttypescripation

```igur

### Confode
```ations-nntto-instrumeauetry/elemode @opentry/sdk-n@opentelemetapi telemetry/ll @openm instaash
npn

```bInstallatio

### ûts.ence et co latueriagnostiqbué pour dg distri
Tracinelemetry)
nTOpeilité (ervabObs 📊 ##

---

header)cy-key-mpotenpi-idehttpa-ietf-ml/draft/doc/htietf.orgker.datatrac://tps](ht Headery-KeympotencIETF Idences:**
- [
**Référe
```

}(result);se.jsonResponurn et}

  r0000);
  ), 8640encyKeylete(idempotcyCache.deten=> idempoimeout(() 
    setTlt);ey, resuidempotencyKe.set(yCachmpotenc ide{
   potencyKey)  (idemr 24h
  if poucker // Sto
  
 );uest.json()eqwait raign(aCampait process = awsultt re conse
  requêtla// Traiter 

  yKey));
  }idempotencCache.get(tencymposon(ideesponse.j   return R
 t en cachee résultaetourner l R {
    //ey))mpotencyKache.has(idedempotencyC& icyKey &empoten(id  if   
y');
potency-Ket('Idemgeders.equest.heayKey = rdempotenc
  const it) {RequesT(request: nction POSasync fu

export >();string, anyw Map< neCache =tencynst idempoute.ts
cos/roapi/campaignpp/
// aipt``typescr
`te)
Rouxt.js API eur (NeCôté Serv
### 
}
```
n();response.jso
  return t originala le résulta retourner/ Le serveurlé
  /e cc la mêm avepeut retrytimeout, on 

  // Si  });ify(data)
 .stringbody: JSON},
       ncyKey
 ': idempotempotency-Keyde',
      'Iion/jsonicate': 'applntent-Typ 'Co: {
        headersST',
 : 'POod {
    meth/campaigns',pi/a('ait fetchesponse = aw const r  
 );
ampaign'y('ctencyKeteIdempogeneray = dempotencyKe  const i {
: any)taCampaign(dacreatetion ync funcced';

asdvan/ai-router-arvices@/lib/serom '} fencyKey empot generateIdrt {impoript
pesc

```tymentation
### Implé.
eouttimrès sur retry ap doublons 
Évite lese
tencmpode
## 🔑 I
---

tputs)tured-ouides/struc.com/docs/guopenaitform.tps://pla Outputs](htucturedenAI Str
- [Op:**nces**Référe```

n Doe"
); // "Johprofile.namele.log(
consoontent);0].message.cta.choices[arse(da= JSON.pprofile onst éma
cle sche selon N validest un JSOe.content s[0].messaghoiceta.con();
// da.jsset respon awaionst data =
});

cmat
  })seForpon_format: res   response
 
    ],e.com' }john@examploe, 30, o: John Dser inft unt: 'Extracer', conte role: 'us { [
     s:ge,
    messa-mini'pt-4o 'gel:mody({
    .stringifody: JSON'POST',
  b
  method: at', {penai/chpi/ofetch('/aait e = awresponsnst l API
co dans l'appeiliser
// Utrue
});
 tstrict:
  ema,fileSchema: userProschile',
  user_profame: '
  nmat({utputFordOcture buildStrumat =eFort respons
consmat le forConstruire;

// 
}ties: falseerditionalProp
  ad'email'], ['name',  required:
 },     }

 tring' } type: 's items: {
     ay',pe: 'arr    tytags: {
  },
    : 'email' mattring', for: 's: { typeemail
    imum: 0 },inr', mumbe: 'nge: { type
    a'string' },e: { type: 
    nam{ties: 
  properobject',
  type: 'ma = {SchefileuserProa
const hémfinir le sc;

// Dér-advanced'-route/services/aiibm '@/lt } froutputFormaStructuredOldbui{ 
import pescript`ty
``Exemple
## lling.

#catool-t xtractions eur e porictON Schema sttputs

JSd Ouureruct# 📐 St-

#tion)

--masage-infor/#uapisreaming-llm-ug/8/st024/Ason.net/2lionwilsimhttps://)](ison(Simon Will Streaming age in- [Usming)
streance/referei-cs/ap/do.openai.com/platforme](https:/ing GuidamI Stre[OpenA**
- s:
**Référence}
}
```
;
  .error)nkor:', chuStream errsole.error('
    con') { 'errornk.type ===lse if (chu}
  ehed)`);
  d(1)}% cacte.toFixeitRa} (${cacheHns{totalToke\nTokens: $\n`og(sole.l   cons) * 100;
 omptTokene.prhunk.usagdTokens / c(cachetRate =  cacheHi   const
    
 ens || 0;.cachedTok.usagekens = chunkcachedTo
    ns;totalTokehunk.usage. calTokens =  tot{
  ) age'= 'us==unk.type else if (ch
  } 
  ;.content)hunkut.write(ccess.stdoro   pent;
 cont += chunk.sponse   fullRe {
 content')k.type === 'hun
  if (cy)) {at', bodpenai/chi/oion('/apmpletamCorenk of sthu(const ct or awai;

f= 0okens  cachedT0;
letlTokens = et totase = '';
llResponful
};

let ue }ge: trusa include_: {ionstream_opt s: true,
 e
  stream d'usagacking le trtiverAcT: IMPORTAN ],
  // puting' }
 quantum com: 'Explain ntent, co 'user'role:' },
    { sistantful as a help 'You aretent:ystem', cone: 's    { roles: [

  messag-4o-mini',model: 'gpt
  = {dy 

const bo';eddvancer-aai-routervices/'@/lib/s} from ompletion treamC { srtimpocript


```typesionuratfig

### Con).acheincluant c tokens (cking deste avec traobustreaming rSSE s

ckingTrac Usage  aveStreaming

## 🌊 a)

---quothow-to/ces/openai/re/ai-servi-us/azut.com/enofmicrosn./lear(https:/it Headers]e Lim Ratzureits)
- [Ae-limdes/ratdocs/gui.com/penai//platform.os](https:e LimitOpenAI Rates:**
- [éférenc**R}
```

se.json();
ponresn   retur}


  body);ll(url, APICakeSmart return mary
   
    // Ret);
    epMs)sle, vemeout(resolsetTi> olve =resmise( new Proawaitms`);
    sleepMs}g ${sleepin limited - g(`Rateole.lo
    consse.headers);on(respteLimitSleepeRaomput cpMs =const sleetter
    ec jimal av délai optialculer le // C {
    === 429)us.statse(responif ;

  okens)iningTts.remateLimi', raokens:ng t('Remainisole.logs);
  conngRequestemainits.rmits:', rateLining reques('Remailogconsole.aders);
  onse.heesptHeaders(rteLimis = parseRast rateLimit
  consate limites r  // Lire l;

  })ody)
fy(bstringi body: JSON.  POST',
  method: 'url, {
   t fetch(= awaise onresp {
  const  any), body:url: stringICall(SmartAPn makeio funct;

asyncd'ceouter-advanai-r/services//lib '@omrs } freadeeLimitHRat parseLimitSleep,puteRatemport { comescript
iyp
```tn
mentatio# Impléitter.

## j-*` avecelimiters `x-ratpar les headkoff piloté acigent

Bting Intell️ Rate Limi
## ⏱
---
reaker)
uit-brns/circtteure/pahitectarce/m/en-us/azurft.co.microso://learnrn](httpsatteBreaker Prcuit - [Azure Cies:**
éférenc
**R```
s}`);
ilurerics.fametailures: ${s.state}, F${metricrcuit: e.log(`Ci;
consolgetMetrics()= breaker.st metrics toring
conni}

// Moerror;

  throw 
  }esponse(); fallbackR  returnback
  alltiliser fgradé - u Service dé) {
    //')r is OPENeake('Circuit brge.includesr.messaerro  if (ror) {
} catch (er
  });
 ... });chat', {('/api/ai/akeAPICallawait m  return () => {
  ute(async r.execreake bait = awresultst  {
  conript
try```typesclisation

### Uti```


});
de 1 minte ssanFenêtre gli/ 000        /60_ize: 
  windowSenophalf-ant 0s avttend 3   // A00,       meout: 30_0s
  tirès 2 succè/ Ferme ap  /2,    hreshold: successThecs
  après 5 éc/ Ouvre       /hreshold: 5,lureT{
  faiuitBreaker( Circreaker = new

const bvanced';uter-ad/ai-roeservicom '@/lib/s fritBreaker } Circut
import {crip
```typesn
uratio## Config

#.gradéeI est dé'APd lrms" quan stoes "retry
Prévient laker
cuit Bre

## 🔌 Cir-ples)

--#exemplets](xemples Com [E#slos)
8.onitoring](. [SLOs & Me)
7ilitvabtry)](#obsermeenTeleOpté (iliabserv)
6. [Obtenceponce](#idem [Idempote
5.s)ured-output#struct](red Outputs4. [Structustreaming)
(#ng] Trackiagec Using ave [Stream3.
ting)te-limit](#raligeniting Intele Lim
2. [Ratit-breaker)cuker](#cirea[Circuit Br. 

1 Matières des 📋 Table

##timisations. opc toutes lesuction aver AI en prod routeu leur déployere complet po

Guiduction Prod deider - Gu# AI Route