# üöÄ Huntaze OnlyFans - Guide de D√©ploiement

Guide complet pour d√©ployer l'int√©gration OnlyFans sur AWS avec ECS Fargate + Playwright.

---

## üìã Pr√©requis

### 1. Outils Requis

```bash
# V√©rifier les installations
node --version    # v18+ requis
npm --version     # v9+ requis
aws --version     # AWS CLI v2+ requis
cdk --version     # AWS CDK v2+ requis
```

### 2. Credentials AWS

```bash
# Configurer AWS CLI
aws configure

# Ou exporter les variables d'environnement
export AWS_ACCESS_KEY_ID=xxxxx
export AWS_SECRET_ACCESS_KEY=xxxxx
export AWS_DEFAULT_REGION=us-east-1
```

### 3. Permissions IAM Requises

Votre utilisateur AWS doit avoir les permissions suivantes :
- `AmazonECS_FullAccess`
- `AmazonDynamoDBFullAccess`
- `AWSLambda_FullAccess`
- `AWSKeyManagementServicePowerUser`
- `CloudWatchFullAccess`
- `IAMFullAccess` (pour cr√©er les r√¥les)
- `AWSCloudFormationFullAccess`

---

## üéØ M√©thode 1 : D√©ploiement Automatique (Recommand√©)

### Option A : Script Tout-en-Un

```bash
# Ex√©cuter le script de d√©ploiement automatique
./scripts/deploy-onlyfans.sh
```

Ce script va :
1. ‚úÖ V√©rifier les pr√©requis
2. ‚úÖ D√©ployer le stack CDK
3. ‚úÖ R√©cup√©rer les outputs
4. ‚úÖ D√©ployer le Lambda
5. ‚úÖ Cr√©er le fichier `.env.production`
6. ‚úÖ Lancer les tests d'int√©gration

**Dur√©e estim√©e : 10-15 minutes**

---

## üîß M√©thode 2 : D√©ploiement Manuel (√âtape par √âtape)

### √âtape 1 : D√©ployer le Stack CDK (30 min)

```bash
# 1. Aller dans le r√©pertoire CDK
cd infra/cdk

# 2. Installer les d√©pendances
npm install

# 3. Build le stack
npm run build

# 4. Bootstrap CDK (premi√®re fois seulement)
npx cdk bootstrap aws://317805897534/us-east-1

# 5. D√©ployer le stack
npx cdk deploy HuntazeOnlyFansStack --require-approval never
```

**Ressources cr√©√©es :**
- ‚úÖ VPC avec subnets publics/priv√©s
- ‚úÖ ECS Cluster Fargate
- ‚úÖ Task Definition avec Playwright
- ‚úÖ DynamoDB Tables (Sessions, Threads, Messages)
- ‚úÖ KMS Key pour chiffrement
- ‚úÖ CloudWatch Log Groups
- ‚úÖ IAM Roles et Policies
- ‚úÖ Security Groups

**Outputs attendus :**
```
HuntazeOnlyFansStack.ECSClusterArn = arn:aws:ecs:us-east-1:317805897534:cluster/huntaze-of-fargate
HuntazeOnlyFansStack.TaskDefinitionArn = arn:aws:ecs:us-east-1:317805897534:task-definition/...
HuntazeOnlyFansStack.SessionsTableName = HuntazeOfSessions
HuntazeOnlyFansStack.MessagesTableName = HuntazeOfMessages
HuntazeOnlyFansStack.KMSKeyId = arn:aws:kms:us-east-1:317805897534:key/...
```

### √âtape 2 : Configurer les Variables d'Environnement (5 min)

Cr√©er le fichier `.env.production` :

```bash
# AWS Configuration
AWS_REGION=us-east-1
AWS_ACCOUNT_ID=317805897534

# ECS Configuration (copier depuis les outputs CDK)
ECS_CLUSTER_ARN=arn:aws:ecs:us-east-1:317805897534:cluster/huntaze-of-fargate
ECS_TASK_DEFINITION=HuntazeOfStackBrowserWorkerTaskXXX:1
ECS_SUBNETS=subnet-xxxxx,subnet-yyyyy
ECS_SECURITY_GROUPS=sg-xxxxx

# DynamoDB Configuration
DYNAMODB_REGION=us-east-1
DYNAMODB_TABLE_SESSIONS=HuntazeOfSessions
DYNAMODB_TABLE_THREADS=HuntazeOfThreads
DYNAMODB_TABLE_MESSAGES=HuntazeOfMessages

# KMS Configuration
KMS_KEY_ID=arn:aws:kms:us-east-1:317805897534:key/c554a2c6-56e1-430c-b191-78e56502c0df

# Secrets Manager
SECRETS_MANAGER_SECRET=of/creds/huntaze

# Feature Flags
PLAYWRIGHT_ENABLED_PERCENT=10
ENVIRONMENT=production

# Monitoring
ENABLE_DETAILED_LOGS=true
ENABLE_METRICS=true
METRICS_INTERVAL=60000
```

### √âtape 3 : D√©ployer le Lambda Orchestrator (20 min)

```bash
# 1. Aller dans le r√©pertoire Lambda
cd infra/lambda/orchestrator

# 2. Installer les d√©pendances
npm install

# 3. Build le code TypeScript
npm run build

# 4. Packager la fonction
zip -r function.zip index.js node_modules/

# 5. Cr√©er la fonction Lambda
aws lambda create-function \
  --function-name huntaze-of-orchestrator \
  --runtime nodejs18.x \
  --role arn:aws:iam::317805897534:role/lambda-execution-role \
  --handler index.handler \
  --zip-file fileb://function.zip \
  --timeout 60 \
  --memory-size 512 \
  --region us-east-1 \
  --environment "Variables={
    ECS_CLUSTER_ARN=arn:aws:ecs:us-east-1:317805897534:cluster/huntaze-of-fargate,
    ECS_TASK_DEFINITION=HuntazeOfStackBrowserWorkerTaskXXX:1,
    DYNAMODB_TABLE_SESSIONS=HuntazeOfSessions,
    DYNAMODB_TABLE_MESSAGES=HuntazeOfMessages,
    KMS_KEY_ID=arn:aws:kms:us-east-1:317805897534:key/xxx
  }"

# Ou mettre √† jour si elle existe d√©j√†
aws lambda update-function-code \
  --function-name huntaze-of-orchestrator \
  --zip-file fileb://function.zip \
  --region us-east-1
```

### √âtape 4 : Configurer les Secrets OnlyFans (10 min)

```bash
# Cr√©er le secret dans AWS Secrets Manager
aws secretsmanager create-secret \
  --name of/creds/huntaze \
  --description "OnlyFans credentials for Huntaze" \
  --secret-string '{
    "username": "your-onlyfans-username",
    "password": "your-onlyfans-password",
    "cookies": {}
  }' \
  --region us-east-1
```

### √âtape 5 : Tester l'Int√©gration (15 min)

```bash
# Retour √† la racine du projet
cd ../../..

# Installer les d√©pendances de test
npm install

# Lancer les tests d'int√©gration
npm test -- tests/integration/playwright-ecs.integration.test.ts

# Lancer les tests de charge (optionnel)
npm run test:load
```

**Tests attendus :**
- ‚úÖ Envoi de message via ECS Fargate
- ‚úÖ Gestion du rate limiting
- ‚úÖ T√¢ches concurrentes
- ‚úÖ Limites par type de compte
- ‚úÖ Gestion des erreurs

---

## üìä V√©rification du D√©ploiement

### 1. V√©rifier le Stack CDK

```bash
# Lister les stacks
aws cloudformation list-stacks --region us-east-1

# Voir les d√©tails du stack
aws cloudformation describe-stacks \
  --stack-name HuntazeOnlyFansStack \
  --region us-east-1
```

### 2. V√©rifier l'ECS Cluster

```bash
# Lister les clusters
aws ecs list-clusters --region us-east-1

# Voir les d√©tails du cluster
aws ecs describe-clusters \
  --clusters huntaze-of-fargate \
  --region us-east-1
```

### 3. V√©rifier les Tables DynamoDB

```bash
# Lister les tables
aws dynamodb list-tables --region us-east-1

# Voir les d√©tails d'une table
aws dynamodb describe-table \
  --table-name HuntazeOfSessions \
  --region us-east-1
```

### 4. V√©rifier le Lambda

```bash
# Lister les fonctions
aws lambda list-functions --region us-east-1

# Voir les d√©tails de la fonction
aws lambda get-function \
  --function-name huntaze-of-orchestrator \
  --region us-east-1
```

### 5. Tester Manuellement

```bash
# Invoquer le Lambda directement
aws lambda invoke \
  --function-name huntaze-of-orchestrator \
  --payload '{"action":"SEND_MESSAGE","userId":"test","data":{"recipientId":"fan-1","content":"Test","accountType":"established"}}' \
  --region us-east-1 \
  response.json

# Voir la r√©ponse
cat response.json
```

---

## üöÄ Rollout Progressif

### Phase 1 : Beta (10% - Jour 1-2)

```bash
# Activer pour 10% des utilisateurs
echo "PLAYWRIGHT_ENABLED_PERCENT=10" >> .env.production

# Red√©ployer l'application
npm run deploy
```

**Monitoring :**
- V√©rifier CloudWatch Logs toutes les 30 minutes
- P95 latency < 500ms ‚úÖ
- Success rate > 99% ‚úÖ
- Pas de rate limit hits > 10% ‚úÖ

### Phase 2 : Expansion (50% - Jour 3-4)

```bash
# Augmenter √† 50%
echo "PLAYWRIGHT_ENABLED_PERCENT=50" >> .env.production
npm run deploy
```

**Validation :**
- V√©rifier l'auto-scaling ECS
- Monitorer les co√ªts AWS
- Valider les m√©triques de performance

### Phase 3 : Production Compl√®te (100% - Jour 5-7)

```bash
# Rollout complet
echo "PLAYWRIGHT_ENABLED_PERCENT=100" >> .env.production
npm run deploy
```

**Production stable :**
- Monitoring 24/7 actif
- Alertes configur√©es
- On-call pr√™t

---

## üìà Monitoring et Alertes

### CloudWatch Dashboards

```bash
# Cr√©er un dashboard personnalis√©
aws cloudwatch put-dashboard \
  --dashboard-name HuntazeOnlyFans \
  --dashboard-body file://alerting/cloudwatch-dashboard.json \
  --region us-east-1
```

### M√©triques Cl√©s √† Surveiller

1. **Performance**
   - P95 Latency : < 300ms
   - P99 Latency : < 500ms
   - Success Rate : > 99.5%
   - Error Rate : < 0.5%

2. **Business**
   - Messages envoy√©s/jour : ~12,500
   - Taux de conversion : > 95%
   - Rate limit hits : < 2%

3. **Infrastructure**
   - ECS tasks actives : 1-2 concurrent
   - DynamoDB write units : < 10/sec
   - Lambda invocations : ~500/jour
   - Co√ªt total : $25-50/mois

### Alertes PagerDuty

```bash
# Configurer les alertes
kubectl apply -f alerting/onlyfans-alerts.yml
```

---

## üîß Troubleshooting

### Probl√®me : CDK Deploy √©choue

**Solution :**
```bash
# V√©rifier les credentials
aws sts get-caller-identity

# Nettoyer et r√©essayer
cd infra/cdk
rm -rf node_modules cdk.out
npm install
npm run build
npx cdk deploy --require-approval never
```

### Probl√®me : Lambda timeout

**Solution :**
```bash
# Augmenter le timeout
aws lambda update-function-configuration \
  --function-name huntaze-of-orchestrator \
  --timeout 120 \
  --region us-east-1
```

### Probl√®me : ECS Task ne d√©marre pas

**Solution :**
```bash
# V√©rifier les logs
aws logs tail /aws/ecs/huntaze-of-fargate --follow --region us-east-1

# V√©rifier la task definition
aws ecs describe-task-definition \
  --task-definition HuntazeOfStackBrowserWorkerTask \
  --region us-east-1
```

### Probl√®me : Rate limiting trop agressif

**Solution :**
```bash
# Ajuster les limites dans lib/features/flags.ts
# Puis red√©ployer
npm run deploy
```

---

## üìö Ressources Utiles

### Documentation AWS
- [ECS Fargate](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/AWS_Fargate.html)
- [DynamoDB](https://docs.aws.amazon.com/dynamodb/)
- [Lambda](https://docs.aws.amazon.com/lambda/)
- [CDK](https://docs.aws.amazon.com/cdk/)

### Monitoring
- [CloudWatch Console](https://console.aws.amazon.com/cloudwatch/)
- [ECS Console](https://console.aws.amazon.com/ecs/)
- [DynamoDB Console](https://console.aws.amazon.com/dynamodb/)

### Support
- Slack: #huntaze-onlyfans
- Email: support@huntaze.com
- On-call: +1-XXX-XXX-XXXX

---

## ‚úÖ Checklist Finale

Avant de lancer en production :

- [ ] CDK stack d√©ploy√© avec succ√®s
- [ ] Lambda orchestrator d√©ploy√©
- [ ] Variables d'environnement configur√©es
- [ ] Secrets OnlyFans configur√©s dans AWS Secrets Manager
- [ ] Tests d'int√©gration passent (> 95%)
- [ ] Tests de charge valid√©s
- [ ] CloudWatch dashboards cr√©√©s
- [ ] Alertes PagerDuty configur√©es
- [ ] Documentation √† jour
- [ ] √âquipe on-call brief√©e
- [ ] Rollback plan document√©
- [ ] Feature flag √† 10% pour beta

---

**üéâ Pr√™t pour le lancement !**

Une fois tous les √©l√©ments coch√©s, vous √™tes pr√™t √† lancer la beta avec 10% des utilisateurs, puis √† augmenter progressivement jusqu'√† 100%.

**Bonne chance ! üöÄ**
