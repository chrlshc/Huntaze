#!/usr/bin/env node

/**
 * Safe Deployments Setup Script
 * Automated setup and configuration of canary and blue-green deployments
 */

const fs = require('fs').promises;
const path = require('path');

const DEPLOYMENT_CONFIG = {
  strategies: {
    canary: {
      default: {
        trafficSteps: [5, 25, 50, 100],
        analysisDuration: 300,
        autoPromote: true,
        maxDuration: 3600,
        successCriteria: {
          errorRate: 1,
          latencyP95: 500,
          latencyP99: 1000,
          successRate: 99,
          minDuration: 300
        },
        rollbackTriggers: {
          errorRate: 5,
          latencyP95: 1000,
          latencyP99: 2000,
          successRate: 95,
          healthCheckFailures: 80
        }
      },
      aggressive: {
        trafficSteps: [10, 50, 100],
        analysisDuration: 180,
        autoPromote: true,
        maxDuration: 1800
      },
      conservative: {
        trafficSteps: [1, 5, 25, 50, 100],
        analysisDuration: 600,
        autoPromote: false,
        maxDuration: 7200
      }
    },
    blueGreen: {
      default: {
        healthCheckTimeout: 60,
        validationTimeout: 300,
        monitoringDuration: 600,
        rollbackTimeout: 30,
        preDeploymentChecks: ['database_migration', 'config_validation'],
        postDeploymentChecks: ['service_health', 'dependency_check'],
        smokeTests: ['api_smoke_test', 'critical_path_test'],
        autoSwitch: true,
        autoRollback: true
      },
      fast: {
        healthCheckTimeout: 30,
        validationTimeout: 120,
        monitoringDuration: 300,
        rollbackTimeout: 15
      },
      thorough: {
        healthCheckTimeout: 120,
        validationTimeout: 600,
        monitoringDuration: 1200,
        rollbackTimeout: 60,
        smokeTests: ['api_smoke_test', 'critical_path_test', 'integration_test', 'performance_test']
      }
    }
  },
  errorBudget: {
    services: {
      'api-gateway': {
        sloTarget: 0.999,
        windowDuration: 2592000,
        freezeThreshold: 0.05,
        warningThreshold: 0.20,
        criticalThreshold: 0.02,
        recoveryThreshold: 0.10
      },
      'user-service': {
        sloTarget: 0.995,
        windowDuration: 2592000,
        freezeThreshold: 0.10,
        warningThreshold: 0.25,
        criticalThreshold: 0.05,
        recoveryThreshold: 0.15
      },
      'analytics-service': {
        sloTarget: 0.99,
        windowDuration: 2592000,
        freezeThreshold: 0.15,
        warningThreshold: 0.30,
        criticalThreshold: 0.08,
        recoveryThreshold: 0.20
      }
    }
  },
  environments: {
    development: {
      errorBudgetGate: false,
      autoRollback: true,
      analysisDuration: 60,
      approvalRequired: false
    },
    staging: {
      errorBudgetGate: false,
      autoRollback: true,
      analysisDuration: 180,
      approvalRequired: false
    },
    production: {
      errorBudgetGate: true,
      autoRollback: true,
      analysisDuration: 300,
      approvalRequired: true
    }
  },
  monitoring: {
    metricsRetention: 604800000, // 7 days
    analysisInterval: 30000,     // 30 seconds
    alertThresholds: {
      deploymentFailures: 3,
      rollbackRate: 20,
      errorBudgetExhaustion: 0.1
    }
  }
};

async function setupSafeDeployments() {
  console.log('üöÄ Setting up Safe Deployments System...\n');

  try {
    // 1. Create deployment configuration file
    console.log('üìù Creating deployment configuration...');
    await fs.writeFile(
      'deployment.config.json',
      JSON.stringify(DEPLOYMENT_CONFIG, null, 2)
    );
    console.log('‚úÖ Deployment configuration created\n');

    // 2. Verify deployment modules exist
    console.log('üîç Verifying deployment modules...');
    const modules = [
      'lib/deployments/canaryController.ts',
      'lib/deployments/blueGreenController.ts',
      'lib/deployments/errorBudgetGate.ts'
    ];

    for (const module of modules) {
      try {
        await fs.access(module);
        console.log(`‚úÖ ${module}`);
      } catch (error) {
        console.log(`‚ùå ${module} - Missing!`);
        throw new Error(`Required module ${module} not found`);
      }
    }
    console.log('');

    // 3. Create deployment initialization script
    console.log('üöÄ Creating deployment initialization script...');
    const initScript = `/**
 * Safe Deployments Initialization
 * Auto-generated by setup-safe-deployments.js
 */

import { canaryController } from '@/lib/deployments/canaryController';
import { blueGreenController } from '@/lib/deployments/blueGreenController';
import { errorBudgetGate, setupDefaultErrorBudgetGates } from '@/lib/deployments/errorBudgetGate';

let deploymentsInitialized = false;

export async function initializeSafeDeployments() {
  if (deploymentsInitialized) {
    console.log('Safe deployments already initialized');
    return;
  }

  try {
    console.log('üöÄ Initializing safe deployments system...');

    // Setup error budget gates
    setupDefaultErrorBudgetGates();
    console.log('‚úÖ Error budget gates configured');

    // Start continuous monitoring
    errorBudgetGate.startContinuousMonitoring();
    console.log('‚úÖ Error budget monitoring started');

    deploymentsInitialized = true;
    console.log('üéØ Safe deployments system initialized successfully');

    // Start periodic cleanup
    startPeriodicCleanup();
  } catch (error) {
    console.error('‚ùå Safe deployments initialization failed:', error);
    throw error;
  }
}

function startPeriodicCleanup() {
  // Clean up old deployment records every hour
  setInterval(() => {
    try {
      cleanupOldDeployments();
    } catch (error) {
      console.error('Deployment cleanup failed:', error);
    }
  }, 3600000); // 1 hour
}

function cleanupOldDeployments() {
  const cutoffTime = Date.now() - (7 * 24 * 60 * 60 * 1000); // 7 days ago
  
  // Clean up old canary deployments
  const canaryDeployments = canaryController.getAllDeployments();
  const oldCanaryDeployments = canaryDeployments.filter(d => 
    d.completedAt && d.completedAt < cutoffTime
  );
  
  // Clean up old blue-green deployments
  const blueGreenDeployments = blueGreenController.getAllDeployments();
  const oldBlueGreenDeployments = blueGreenDeployments.filter(d => 
    d.completedAt && d.completedAt < cutoffTime
  );
  
  console.log(\`üßπ Cleaned up \${oldCanaryDeployments.length} canary and \${oldBlueGreenDeployments.length} blue-green deployments\`);
}

// Auto-initialize in production
if (process.env.NODE_ENV === 'production') {
  initializeSafeDeployments().catch(console.error);
}

// Export deployment controllers for external use
export { canaryController, blueGreenController, errorBudgetGate };
`;

    await fs.writeFile('lib/deployments/init.ts', initScript);
    console.log('‚úÖ Deployment initialization script created\n');

    // 4. Create deployment CLI tool
    console.log('üîß Creating deployment CLI tool...');
    const cliScript = `#!/usr/bin/env node

/**
 * Safe Deployments CLI Tool
 */

const http = require('http');

class DeploymentCLI {
  async deploy(serviceName, version, strategy = 'canary', options = {}) {
    console.log(\`üöÄ Starting \${strategy} deployment: \${serviceName}:\${version}\`);
    
    try {
      // Check error budget first
      const budgetCheck = await this.makeRequest('/api/deployments/status', {
        method: 'POST',
        body: JSON.stringify({
          action: 'check_error_budget',
          serviceName,
          deploymentType: options.critical ? 'critical' : 'normal'
        })
      });
      
      if (!budgetCheck.result.allowed) {
        console.log(\`‚ùå Deployment blocked: \${budgetCheck.result.reason}\`);
        console.log('üí° Recommendations:');
        budgetCheck.result.recommendations.forEach(rec => console.log(\`   - \${rec}\`));
        return false;
      }
      
      console.log(\`‚úÖ Error budget check passed: \${budgetCheck.result.reason}\`);
      
      // Start deployment
      const deployment = await this.makeRequest('/api/deployments/status', {
        method: 'POST',
        body: JSON.stringify({
          action: strategy === 'canary' ? 'start_canary' : 'start_blue_green',
          config: {
            serviceName,
            version,
            ...options
          }
        })
      });
      
      if (deployment.success) {
        console.log(\`‚úÖ Deployment started: \${deployment.deploymentId}\`);
        
        if (options.watch) {
          await this.watchDeployment(deployment.deploymentId, strategy);
        }
        
        return deployment.deploymentId;
      } else {
        console.log(\`‚ùå Deployment failed to start: \${deployment.error}\`);
        return false;
      }
    } catch (error) {
      console.error(\`‚ùå Deployment error: \${error.message}\`);
      return false;
    }
  }
  
  async rollback(deploymentId, reason = 'Manual rollback') {
    console.log(\`‚è™ Rolling back deployment: \${deploymentId}\`);
    
    try {
      // Determine deployment type and rollback
      const status = await this.getDeploymentStatus();
      const deployment = this.findDeployment(status, deploymentId);
      
      if (!deployment) {
        console.log(\`‚ùå Deployment not found: \${deploymentId}\`);
        return false;
      }
      
      const action = deployment.type === 'canary' ? 'rollback_canary' : 'rollback_blue_green';
      
      const result = await this.makeRequest('/api/deployments/status', {
        method: 'POST',
        body: JSON.stringify({
          action,
          deploymentId,
          reason
        })
      });
      
      if (result.success) {
        console.log(\`‚úÖ Rollback completed: \${reason}\`);
        return true;
      } else {
        console.log(\`‚ùå Rollback failed: \${result.error}\`);
        return false;
      }
    } catch (error) {
      console.error(\`‚ùå Rollback error: \${error.message}\`);
      return false;
    }
  }
  
  async status(serviceName) {
    try {
      const status = await this.getDeploymentStatus(serviceName);
      
      console.log('üìä Deployment System Status');
      console.log('=' .repeat(40));
      
      // Canary deployments
      console.log(\`\\nüê§ Canary Deployments: \${status.deployments.canary.total} total, \${status.deployments.canary.active} active\`);
      if (status.deployments.canary.active > 0) {
        status.deployments.canary.deployments.forEach(d => {
          if (['STAGE_5', 'STAGE_25', 'STAGE_50', 'STAGE_100'].includes(d.stage)) {
            console.log(\`   üìà \${d.config.serviceName}:\${d.config.version} - \${d.stage} (\${d.trafficPercentage}%)\`);
          }
        });
      }
      
      // Blue-Green deployments
      console.log(\`\\nüîµüü¢ Blue-Green Deployments: \${status.deployments.blueGreen.total} total, \${status.deployments.blueGreen.active} active\`);
      if (status.deployments.blueGreen.active > 0) {
        status.deployments.blueGreen.deployments.forEach(d => {
          if (['DEPLOYING_GREEN', 'VALIDATING_GREEN', 'SWITCHING_TRAFFIC', 'MONITORING'].includes(d.stage)) {
            console.log(\`   üîÑ \${d.config.serviceName}:\${d.config.version} - \${d.stage}\`);
          }
        });
      }
      
      // Error budget status
      console.log(\`\\nüìä Error Budget Status:\`);
      status.deployments.errorBudget.statuses.forEach(s => {
        const statusIcon = s.status === 'HEALTHY' ? '‚úÖ' : s.status === 'WARNING' ? '‚ö†Ô∏è' : s.status === 'CRITICAL' ? 'üî∂' : 'üî¥';
        console.log(\`   \${statusIcon} \${s.serviceName}: \${(s.errorBudget * 100).toFixed(1)}% budget remaining (\${s.status})\`);
      });
      
      return status;
    } catch (error) {
      console.error(\`‚ùå Status error: \${error.message}\`);
      return null;
    }
  }
  
  async watchDeployment(deploymentId, strategy) {
    console.log(\`üëÄ Watching deployment: \${deploymentId}\`);
    
    const interval = setInterval(async () => {
      try {
        const status = await this.getDeploymentStatus();
        const deployment = this.findDeployment(status, deploymentId);
        
        if (!deployment) {
          console.log(\`‚ùå Deployment not found: \${deploymentId}\`);
          clearInterval(interval);
          return;
        }
        
        console.log(\`üìä \${new Date().toLocaleTimeString()} - \${deployment.stage} (\${deployment.trafficPercentage || 0}%)\`);
        
        if (['COMPLETED', 'FAILED', 'ROLLED_BACK'].includes(deployment.stage)) {
          const statusIcon = deployment.stage === 'COMPLETED' ? '‚úÖ' : '‚ùå';
          console.log(\`\${statusIcon} Deployment \${deployment.stage.toLowerCase()}\`);
          clearInterval(interval);
        }
      } catch (error) {
        console.error(\`Watch error: \${error.message}\`);
      }
    }, 10000); // Check every 10 seconds
  }
  
  async getDeploymentStatus(serviceName) {
    const url = serviceName 
      ? \`/api/deployments/status?service=\${serviceName}&history=true&metrics=true\`
      : '/api/deployments/status?history=true&metrics=true';
      
    return this.makeRequest(url);
  }
  
  findDeployment(status, deploymentId) {
    // Check canary deployments
    for (const deployment of status.deployments.canary.deployments) {
      if (deployment.id === deploymentId) {
        return { ...deployment, type: 'canary' };
      }
    }
    
    // Check blue-green deployments
    for (const deployment of status.deployments.blueGreen.deployments) {
      if (deployment.id === deploymentId) {
        return { ...deployment, type: 'blueGreen' };
      }
    }
    
    return null;
  }
  
  async makeRequest(path, options = {}) {
    return new Promise((resolve, reject) => {
      const requestOptions = {
        hostname: 'localhost',
        port: 3000,
        path,
        method: options.method || 'GET',
        headers: {
          'Content-Type': 'application/json',
          ...options.headers
        }
      };

      const req = http.request(requestOptions, (res) => {
        let data = '';
        res.on('data', (chunk) => data += chunk);
        res.on('end', () => {
          try {
            const parsed = JSON.parse(data);
            resolve(parsed);
          } catch (error) {
            reject(new Error(\`Failed to parse response: \${error.message}\`));
          }
        });
      });

      req.on('error', reject);
      
      if (options.body) {
        req.write(options.body);
      }
      
      req.end();
    });
  }
}

// CLI interface
const cli = new DeploymentCLI();
const [,, command, ...args] = process.argv;

switch (command) {
  case 'deploy':
    const [serviceName, version, strategy = 'canary'] = args;
    if (!serviceName || !version) {
      console.log('Usage: deploy <service> <version> [strategy] [--critical] [--watch]');
      process.exit(1);
    }
    
    const options = {
      critical: args.includes('--critical'),
      watch: args.includes('--watch')
    };
    
    cli.deploy(serviceName, version, strategy, options);
    break;
    
  case 'rollback':
    const [deploymentId, ...reasonParts] = args;
    if (!deploymentId) {
      console.log('Usage: rollback <deployment-id> [reason]');
      process.exit(1);
    }
    
    const reason = reasonParts.join(' ') || 'Manual rollback';
    cli.rollback(deploymentId, reason);
    break;
    
  case 'status':
    const [service] = args;
    cli.status(service);
    break;
    
  default:
    console.log('Safe Deployments CLI');
    console.log('');
    console.log('Commands:');
    console.log('  deploy <service> <version> [canary|blue-green] [--critical] [--watch]');
    console.log('  rollback <deployment-id> [reason]');
    console.log('  status [service]');
    console.log('');
    console.log('Examples:');
    console.log('  deploy api-gateway v1.2.3 canary --watch');
    console.log('  deploy user-service v2.0.0 blue-green --critical');
    console.log('  rollback canary-api-gateway-v1.2.3-1699123456-abc123');
    console.log('  status api-gateway');
}
`;

    await fs.writeFile('scripts/deploy-cli.js', cliScript);
    await fs.chmod('scripts/deploy-cli.js', 0o755);
    console.log('‚úÖ Deployment CLI tool created\n');

    // 5. Create package.json scripts
    console.log('üì¶ Adding NPM scripts...');
    try {
      const packageJsonPath = 'package.json';
      const packageJson = JSON.parse(await fs.readFile(packageJsonPath, 'utf8'));
      
      packageJson.scripts = packageJson.scripts || {};
      packageJson.scripts['deploy:setup'] = 'node scripts/setup-safe-deployments.js';
      packageJson.scripts['deploy:canary'] = 'node scripts/deploy-cli.js deploy';
      packageJson.scripts['deploy:blue-green'] = 'node scripts/deploy-cli.js deploy';
      packageJson.scripts['deploy:rollback'] = 'node scripts/deploy-cli.js rollback';
      packageJson.scripts['deploy:status'] = 'node scripts/deploy-cli.js status';
      packageJson.scripts['deploy:dashboard'] = 'open http://localhost:3000/deployments/dashboard';
      
      await fs.writeFile(packageJsonPath, JSON.stringify(packageJson, null, 2));
      console.log('‚úÖ NPM scripts added\n');
    } catch (error) {
      console.log('‚ö†Ô∏è  Could not update package.json scripts\n');
    }

    // 6. Create test script
    console.log('üß™ Creating deployment test script...');
    const testScript = `#!/usr/bin/env node

/**
 * Safe Deployments Test Script
 */

async function testSafeDeployments() {
  console.log('üß™ Testing Safe Deployments System...\\n');
  
  try {
    const { DeploymentCLI } = await import('./deploy-cli.js');
    const cli = new DeploymentCLI();
    
    // Test deployment status
    console.log('üìä Testing deployment status...');
    const status = await cli.status();
    
    if (status) {
      console.log('‚úÖ Deployment status endpoint working');
      console.log(\`   Canary deployments: \${status.deployments.canary.total}\`);
      console.log(\`   Blue-Green deployments: \${status.deployments.blueGreen.total}\`);
      console.log(\`   Error budget services: \${status.deployments.errorBudget.services}\`);
    } else {
      console.log('‚ùå Deployment status endpoint failed');
    }
    
    // Test error budget check
    console.log('\\nüìä Testing error budget check...');
    try {
      const budgetResult = await cli.makeRequest('/api/deployments/status', {
        method: 'POST',
        body: JSON.stringify({
          action: 'check_error_budget',
          serviceName: 'api-gateway',
          deploymentType: 'normal'
        })
      });
      
      if (budgetResult.success) {
        console.log('‚úÖ Error budget check working');
        console.log(\`   Result: \${budgetResult.result.allowed ? 'ALLOWED' : 'BLOCKED'}\`);
        console.log(\`   Reason: \${budgetResult.result.reason}\`);
      } else {
        console.log('‚ùå Error budget check failed');
      }
    } catch (error) {
      console.log(\`‚ùå Error budget check error: \${error.message}\`);
    }
    
    console.log('\\nüéâ Safe deployments test completed!');
    
  } catch (error) {
    console.error('‚ùå Safe deployments test failed:', error.message);
    console.log('\\nüí° Make sure the development server is running: npm run dev');
  }
}

testSafeDeployments();
`;

    await fs.writeFile('scripts/test-safe-deployments.js', testScript);
    await fs.chmod('scripts/test-safe-deployments.js', 0o755);
    console.log('‚úÖ Deployment test script created\n');

    // 7. Create documentation
    console.log('üìö Creating safe deployments documentation...');
    const documentation = `# Safe Deployments Documentation

## Overview
The safe deployments system provides enterprise-grade release safety through canary deployments, blue-green deployments, and error budget gating.

## Deployment Strategies

### 1. Canary Deployments
Progressive traffic rollouts with automated analysis and rollback.

**Use Cases:**
- API services with high traffic
- Services with complex business logic
- When you want gradual risk exposure

**Traffic Progression:** 5% ‚Üí 25% ‚Üí 50% ‚Üí 100%

**Example:**
\`\`\`bash
# Start canary deployment
npm run deploy:canary api-gateway v1.2.3 -- --watch

# Manual promotion
node scripts/deploy-cli.js promote <deployment-id>

# Manual rollback
node scripts/deploy-cli.js rollback <deployment-id> "Performance issues"
\`\`\`

### 2. Blue-Green Deployments
Zero-downtime deployments with instant traffic switching.

**Use Cases:**
- Database schema changes
- Infrastructure updates
- Services requiring full validation before traffic

**Example:**
\`\`\`bash
# Start blue-green deployment
npm run deploy:blue-green user-service v2.0.0

# Manual traffic switch
node scripts/deploy-cli.js switch <deployment-id>

# Rollback if needed
node scripts/deploy-cli.js rollback <deployment-id> "Health checks failed"
\`\`\`

### 3. Error Budget Gating
Prevents deployments when SLO error budget is exhausted.

**Thresholds:**
- **Freeze:** < 10% error budget remaining
- **Warning:** < 25% error budget remaining
- **Critical Fixes Only:** < 5% error budget remaining

**Example:**
\`\`\`bash
# Check error budget before deployment
node scripts/deploy-cli.js status api-gateway

# Deploy critical fix even when frozen
npm run deploy:canary api-gateway v1.2.4 -- --critical
\`\`\`

## Configuration

### Service Configuration
Edit \`deployment.config.json\` to customize deployment strategies per service:

\`\`\`json
{
  "strategies": {
    "canary": {
      "api-gateway": {
        "trafficSteps": [5, 25, 50, 100],
        "analysisDuration": 300,
        "autoPromote": true
      }
    }
  }
}
\`\`\`

### Error Budget Configuration
\`\`\`json
{
  "errorBudget": {
    "services": {
      "api-gateway": {
        "sloTarget": 0.999,
        "freezeThreshold": 0.05
      }
    }
  }
}
\`\`\`

## Monitoring & Metrics

### Success Criteria (Auto-Promotion)
- Error rate < 1%
- P95 latency < 500ms
- P99 latency < 1000ms
- Success rate > 99%
- Minimum analysis duration: 5 minutes

### Rollback Triggers (Auto-Rollback)
- Error rate > 5%
- P95 latency > 1000ms
- P99 latency > 2000ms
- Success rate < 95%
- Health checks < 80%

### Dashboard
Access the deployments dashboard at: \`/deployments/dashboard\`

## CLI Commands

### Deploy
\`\`\`bash
# Canary deployment with monitoring
node scripts/deploy-cli.js deploy api-gateway v1.2.3 canary --watch

# Blue-green deployment
node scripts/deploy-cli.js deploy user-service v2.0.0 blue-green

# Critical fix deployment
node scripts/deploy-cli.js deploy api-gateway v1.2.4 canary --critical
\`\`\`

### Monitor
\`\`\`bash
# Check overall status
node scripts/deploy-cli.js status

# Check specific service
node scripts/deploy-cli.js status api-gateway
\`\`\`

### Control
\`\`\`bash
# Manual rollback
node scripts/deploy-cli.js rollback <deployment-id> "Performance degradation"

# Check deployment status
curl http://localhost:3000/api/deployments/status
\`\`\`

## Best Practices

### Canary Deployments
1. **Start Small:** Begin with 5% traffic
2. **Monitor Closely:** Watch metrics during each stage
3. **Have Rollback Ready:** Prepare rollback plan before deployment
4. **Test Thoroughly:** Validate in staging first

### Blue-Green Deployments
1. **Validate Green:** Ensure green environment is fully healthy
2. **Quick Switch:** Keep traffic switch time under 1 second
3. **Monitor Post-Switch:** Watch for issues after traffic switch
4. **Keep Blue Ready:** Maintain blue environment for quick rollback

### Error Budget Management
1. **Respect Budgets:** Don't deploy when budget is exhausted
2. **Fix Issues First:** Address reliability problems before new features
3. **Monitor Consumption:** Track error budget usage trends
4. **Plan Capacity:** Reserve budget for emergency fixes

## Troubleshooting

### Common Issues
1. **Deployment blocked by error budget:** Wait for budget recovery or deploy critical fix
2. **Canary stuck at stage:** Check metrics and consider manual promotion/rollback
3. **Blue-green validation failed:** Review health checks and fix issues
4. **Rollback not working:** Check rollback triggers and manual override

### Debug Commands
\`\`\`bash
# Check deployment system status
npm run deploy:status

# Test deployment system
npm run test:safe-deployments

# View deployment logs
curl http://localhost:3000/api/deployments/status?history=true&metrics=true
\`\`\`

## Integration

### CI/CD Pipeline Integration
\`\`\`yaml
# Example GitHub Actions workflow
- name: Deploy with Canary
  run: |
    deployment_id=$(node scripts/deploy-cli.js deploy $SERVICE $VERSION canary)
    echo "deployment_id=$deployment_id" >> $GITHUB_OUTPUT

- name: Monitor Deployment
  run: node scripts/deploy-cli.js watch \${{ steps.deploy.outputs.deployment_id }}
\`\`\`

### Prometheus Metrics
The system exports metrics for monitoring:
- \`deployment_duration_seconds\`
- \`deployment_success_rate\`
- \`rollback_duration_seconds\`
- \`error_budget_remaining\`

## Security

### Deployment Approvals
Production deployments can require manual approval:
\`\`\`json
{
  "environments": {
    "production": {
      "approvalRequired": true
    }
  }
}
\`\`\`

### Access Control
Implement role-based access control for deployment operations:
- **Developers:** Can deploy to staging
- **SREs:** Can deploy to production and perform rollbacks
- **On-call:** Can deploy critical fixes during incidents
`;

    await fs.writeFile('docs/SAFE_DEPLOYMENTS.md', documentation);
    console.log('‚úÖ Safe deployments documentation created\n');

    // Success message
    console.log('üéâ Safe Deployments Setup Complete!\n');
    console.log('üìã Summary:');
    console.log('   ‚úÖ Configuration file created (deployment.config.json)');
    console.log('   ‚úÖ Initialization script created (lib/deployments/init.ts)');
    console.log('   ‚úÖ CLI tool created (scripts/deploy-cli.js)');
    console.log('   ‚úÖ Test script created (scripts/test-safe-deployments.js)');
    console.log('   ‚úÖ Documentation created (docs/SAFE_DEPLOYMENTS.md)');
    console.log('   ‚úÖ NPM scripts added to package.json\n');
    
    console.log('üöÄ Next Steps:');
    console.log('   1. Start your development server: npm run dev');
    console.log('   2. Test the deployment system: npm run test:safe-deployments');
    console.log('   3. Try a canary deployment: npm run deploy:canary api-gateway v1.0.0');
    console.log('   4. Check the documentation: docs/SAFE_DEPLOYMENTS.md\n');
    
    console.log('üéØ The safe deployment system is now ready for production use!');
    console.log('   - Canary deployments with automated analysis');
    console.log('   - Blue-green deployments for zero downtime');
    console.log('   - Error budget gating for SLO protection');
    console.log('   - Automated rollback in < 60 seconds\n');

  } catch (error) {
    console.error('‚ùå Safe deployments setup failed:', error);
    process.exit(1);
  }
}

// Run setup
setupSafeDeployments();