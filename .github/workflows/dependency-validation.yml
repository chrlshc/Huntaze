name: Dependency Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/dependency-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/dependency-validation.yml'

jobs:
  validate-dependencies:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --no-audit --no-fund
      
    - name: Validate React + Three.js compatibility
      run: npm run validate:dependencies
      
    - name: Check for dependency conflicts
      run: npm run check:conflicts
      
    - name: Run dependency validation tests
      run: npx vitest run tests/unit/dependencies/dependency-validation.test.ts
      
    - name: Run Three.js component tests
      run: npx vitest run tests/unit/dependencies/threejs-components.test.tsx
      
    - name: Verify TypeScript compilation
      run: npx tsc --noEmit --skipLibCheck
      
    - name: Test build process
      run: npm run build
      env:
        # Mock environment variables for build
        DATABASE_URL: "postgresql://mock:mock@localhost:5432/mock"
        JWT_SECRET: "mock-jwt-secret-for-testing"
        NEXTAUTH_URL: "http://localhost:3000"
        AUTH_SECRET: "mock-auth-secret"
        
    - name: Upload dependency validation report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-validation-report-node-${{ matrix.node-version }}
        path: |
          npm-debug.log*
          .next/
        retention-days: 7

  security-audit:
    runs-on: ubuntu-latest
    needs: validate-dependencies
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --no-audit --no-fund
      
    - name: Run security audit
      run: npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: Check for known vulnerabilities in React ecosystem
      run: |
        echo "Checking React ecosystem security..."
        npm ls react react-dom @react-three/drei @react-three/fiber
        
    - name: Validate package lock integrity
      run: |
        echo "Validating package-lock.json integrity..."
        npm ci --dry-run

  compatibility-matrix:
    runs-on: ubuntu-latest
    needs: validate-dependencies
    
    strategy:
      matrix:
        react-version: ['19.2.0']
        drei-version: ['10.7.6', '10.8.0']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Test React ${{ matrix.react-version }} + drei ${{ matrix.drei-version }}
      run: |
        echo "Testing compatibility: React ${{ matrix.react-version }} + drei ${{ matrix.drei-version }}"
        npm install react@${{ matrix.react-version }} react-dom@${{ matrix.react-version }} @react-three/drei@${{ matrix.drei-version }}
        npm run validate:dependencies
        npx vitest run tests/unit/dependencies/
      continue-on-error: true