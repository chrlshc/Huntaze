version: 1

# Next.js 16 + AWS Amplify Compute Configuration
# Uses Amplify Compute (ECS Fargate) instead of Lambda to avoid cold starts

frontend:
  phases:
    preBuild:
      commands:
        # Clear node_modules to avoid cache issues
        - rm -rf node_modules
        # Install dependencies (using npm install since package-lock.json was removed)
        # Using --legacy-peer-deps to handle @react-three/drei peer dependency conflict
        - npm install --no-audit --legacy-peer-deps
        # Generate Prisma Client (force version 6.19.0 to match package.json)
        - npx prisma@6.19.0 generate
        # Test database connections (non-blocking)
        - npx tsx scripts/test-connections.ts || echo "Connection test completed with warnings"
        # Verify Node.js version (should be 20+)
        - node --version
    
    build:
      commands:
        # CRITICAL: Disable Redis/DB during build to prevent timeouts
        # These connections are only needed at runtime, not build time
        - export DISABLE_REDIS_CACHE=true
        - export DISABLE_DATABASE=true
        # Skip migrations - database is already migrated
        # Migrations should be run manually or via separate deployment pipeline
        # - npx prisma@6.19.0 migrate deploy
        # Build Next.js 16 app with webpack
        - npm run build
        # Verify build output
        - ls -la .next
        - echo "Build completed successfully"
  
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - .next/standalone/**/*

# Backend Configuration (Optional - for custom Lambda functions)
backend:
  phases:
    build:
      commands:
        - npm install --legacy-peer-deps
        - npx prisma@6.19.0 generate

# Compute Configuration (Amplify Compute - NO COLD STARTS)
# This uses ECS Fargate instead of Lambda
compute:
  type: container
  runtime: nodejs20
  memory: 2048  # 2GB RAM
  cpu: 1024     # 1 vCPU
  
  # VPC Configuration for ElastiCache access
  vpc:
    securityGroupIds:
      - ${LAMBDA_SECURITY_GROUP_ID}
    subnetIds:
      - ${PRIVATE_SUBNET_1_ID}
      - ${PRIVATE_SUBNET_2_ID}

# Environment Variables (set in Amplify Console)
# Required:
# - DATABASE_URL=postgresql://user:pass@host/db?sslmode=require
# - REDIS_HOST=your-elasticache.cache.amazonaws.com
# - REDIS_PORT=6379
# - NEXTAUTH_URL=https://app.huntaze.com
# - NEXTAUTH_SECRET=your-secret-here
# - GEMINI_API_KEY=your-gemini-key
# - AWS_REGION=us-east-1
# - AWS_ACCESS_KEY_ID=REDACTED-key
# - AWS_SECRET_ACCESS_KEY=REDACTED-secret
# - S3_BUCKET_NAME=huntaze-assets
# - SES_FROM_EMAIL=noreply@huntaze.com
# - NODE_ENV=production
# - NODE_VERSION=20
# 
# VPC (for compute):
# - LAMBDA_SECURITY_GROUP_ID=sg-xxxxxxxxx
# - PRIVATE_SUBNET_1_ID=subnet-xxxxxxxx
# - PRIVATE_SUBNET_2_ID=subnet-yyyyyyyy
