version: 1

# Next.js 16 + AWS Amplify Hosting (Lambda SSR) build spec.

frontend:
  phases:
    preBuild:
      commands:
        # Prevent stale installs
        - rm -rf node_modules
        # Clean install with legacy peer deps for @react-three/drei
        - npm ci --legacy-peer-deps
        # Generate Prisma Client before build
        - npx prisma generate
        # Verify Node.js version (should be 20+)
        - node --version
        - echo "Prisma client generated"
    
    build:
      commands:
        # Avoid DB/Redis access during build (SSG/SSR pre-render)
        - export DISABLE_REDIS_CACHE=true
        - export DISABLE_DATABASE=true
        # Build Next.js
        - npm run build
  
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

# VPC access (for RDS/ElastiCache):
# Configure in Amplify Console -> App settings -> VPC.
# Select private subnets and a security group that allows 5432/6379 to DB/Redis.
