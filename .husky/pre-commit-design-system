#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Design System Violation Check (Pre-commit Hook)
# This hook runs before each commit to catch design system violations early

echo "üé® Checking for design system violations..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tsx?|css)$')

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No relevant files to check"
  exit 0
fi

# Run quick violation checks on staged files only
VIOLATIONS_FOUND=0

# Check for hardcoded fonts
echo "  Checking font tokens..."
for file in $STAGED_FILES; do
  if grep -q 'font-family: Inter\|font-family: "Inter"\|fontFamily: "Inter"' "$file" 2>/dev/null; then
    echo "    ‚ö†Ô∏è  Font violation in: $file"
    VIOLATIONS_FOUND=1
  fi
done

# Check for hardcoded font sizes
echo "  Checking typography tokens..."
for file in $STAGED_FILES; do
  if grep -q 'font-size: [0-9]\+px\|fontSize: "[0-9]\+px"' "$file" 2>/dev/null; then
    echo "    ‚ö†Ô∏è  Typography violation in: $file"
    VIOLATIONS_FOUND=1
  fi
done

# Check for Tailwind arbitrary classes
echo "  Checking Tailwind classes..."
for file in $STAGED_FILES; do
  if grep -q 'text-\[[0-9]\+px\]' "$file" 2>/dev/null; then
    echo "    ‚ö†Ô∏è  Arbitrary Tailwind class in: $file"
    VIOLATIONS_FOUND=1
  fi
done

# Check for raw button elements in TSX files
echo "  Checking component usage..."
for file in $STAGED_FILES; do
  if [[ $file == *.tsx ]] && ! [[ $file == *.test.tsx ]]; then
    if grep -q '<button' "$file" 2>/dev/null && ! grep -q 'import.*Button.*from.*@/components/ui/button' "$file" 2>/dev/null; then
      echo "    ‚ö†Ô∏è  Raw <button> element in: $file (use <Button> component)"
      VIOLATIONS_FOUND=1
    fi
  fi
done

if [ $VIOLATIONS_FOUND -eq 1 ]; then
  echo ""
  echo "‚ùå Design system violations found!"
  echo ""
  echo "To fix automatically:"
  echo "  npx tsx scripts/auto-migrate-violations.ts --dry-run"
  echo ""
  echo "To see detailed violations:"
  echo "  npx tsx scripts/check-font-token-violations.ts"
  echo "  npx tsx scripts/check-color-palette-violations.ts"
  echo "  npx tsx scripts/check-button-component-violations.ts"
  echo ""
  echo "To bypass this check (not recommended):"
  echo "  git commit --no-verify"
  echo ""
  exit 1
fi

echo "‚úÖ No design system violations detected"
exit 0
