generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ai_plan {
  id           String         @id @db.Uuid
  source       String         @db.VarChar(32)
  account_id   String         @db.VarChar(128)
  created_at   DateTime       @default(now()) @db.Timestamptz(6)
  raw          Json
  ai_plan_item ai_plan_item[]

  @@index([account_id, created_at(sort: Desc)], map: "idx_ai_plan_account_created")
}

model ai_plan_item {
  id           String    @id @db.Uuid
  plan_id      String    @db.Uuid
  platform     String    @db.VarChar(32)
  scheduled_at DateTime? @db.Timestamptz(6)
  content      Json
  status       String    @default("scheduled") @db.VarChar(24)
  ai_plan      ai_plan   @relation(fields: [plan_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([plan_id, platform], map: "idx_item_plan_platform")
  @@index([scheduled_at], map: "idx_item_scheduled")
}

model content {
  id           String    @id
  user_id      Int
  title        String
  text         String?
  type         String    @db.VarChar(50)
  platform     String    @db.VarChar(50)
  status       String    @db.VarChar(50)
  category     String?   @db.VarChar(100)
  tags         String[]
  media_ids    String[]
  scheduled_at DateTime? @db.Timestamp(6)
  published_at DateTime? @db.Timestamp(6)
  created_at   DateTime  @default(now()) @db.Timestamp(6)
  updated_at   DateTime  @default(now()) @db.Timestamp(6)
  metadata     Json?
  users        users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([user_id, platform])
  @@index([user_id, status])
}

model events_outbox {
  id             BigInt    @id @default(autoincrement())
  aggregate_type String
  aggregate_id   String
  event_type     String
  event_time     DateTime  @default(now()) @db.Timestamptz(6)
  payload        Json
  sent_at        DateTime? @db.Timestamptz(6)
}

model insight_snapshot {
  id           BigInt   @id @default(autoincrement())
  platform     String   @db.VarChar(32)
  account_id   String   @db.VarChar(128)
  period_start DateTime @db.Date
  period_end   DateTime @db.Date
  raw          Json
  created_at   DateTime @default(now()) @db.Timestamptz(6)

  @@index([account_id, platform, period_end(sort: Desc)], map: "idx_snapshot_acc_platform")
}

model insight_summary {
  id         BigInt   @id @default(autoincrement())
  platform   String   @db.VarChar(32)
  account_id String   @db.VarChar(128)
  period     String
  summary    Json
  created_at DateTime @default(now()) @db.Timestamptz(6)

  @@index([account_id, platform, created_at(sort: Desc)], map: "idx_summary_acc_platform")
}

model marketing_campaigns {
  id               String   @id
  user_id          Int
  name             String   @db.VarChar(255)
  status           String   @db.VarChar(50)
  channel          String   @db.VarChar(50)
  goal             String   @db.VarChar(50)
  audience_segment String   @db.VarChar(100)
  audience_size    Int
  message          Json
  schedule         Json?
  stats            Json?
  created_at       DateTime @default(now()) @db.Timestamp(6)
  updated_at       DateTime @default(now()) @db.Timestamp(6)
  users            users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, channel])
  @@index([user_id, status])
}

model oauth_accounts {
  id                  Int       @id @default(autoincrement())
  user_id             Int
  provider            String    @db.VarChar(50)
  provider_account_id String    @db.VarChar(255)
  access_token        String?
  refresh_token       String?
  expires_at          DateTime? @db.Timestamp(6)
  token_type          String?   @db.VarChar(50)
  scope               String?
  metadata            Json?
  created_at          DateTime  @default(now()) @db.Timestamp(6)
  updated_at          DateTime  @default(now()) @db.Timestamp(6)
  users               users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
  @@index([user_id, provider])
}

model subscriptions {
  id         String    @id
  user_id    Int
  fan_id     String    @db.VarChar(255)
  platform   String    @db.VarChar(50)
  tier       String?   @db.VarChar(50)
  amount     Float
  status     String    @db.VarChar(50)
  started_at DateTime  @db.Timestamp(6)
  ends_at    DateTime? @db.Timestamp(6)
  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime  @default(now()) @db.Timestamp(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, platform])
  @@index([user_id, status])
}

model transactions {
  id         String   @id
  user_id    Int
  amount     Float
  currency   String   @default("USD") @db.VarChar(10)
  status     String   @db.VarChar(50)
  type       String   @db.VarChar(50)
  platform   String?  @db.VarChar(50)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([user_id, status])
}

model user_stats {
  id                  String   @id
  user_id             Int      @unique
  messages_sent       Int      @default(0)
  messages_trend      Float    @default(0)
  response_rate       Float    @default(0)
  response_rate_trend Float    @default(0)
  revenue             Float    @default(0)
  revenue_trend       Float    @default(0)
  active_chats        Int      @default(0)
  active_chats_trend  Float    @default(0)
  created_at          DateTime @default(now()) @db.Timestamp(6)
  updated_at          DateTime @default(now()) @db.Timestamp(6)
  users               users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model users {
  id                         Int                   @id @default(autoincrement())
  email                      String                @unique @db.VarChar(255)
  name                       String?               @db.VarChar(255)
  password                   String?               @db.VarChar(255)
  email_verified             Boolean?              @default(false)
  email_verification_token   String?               @db.VarChar(255)
  email_verification_expires DateTime?             @db.Timestamp(6)
  created_at                 DateTime?             @default(now()) @db.Timestamp(6)
  updated_at                 DateTime?             @default(now()) @db.Timestamp(6)
  onboarding_completed       Boolean?              @default(false)
  content_types              String[]              @default([])
  goal                       String?               @db.VarChar(100)
  revenue_goal               Int?
  ai_plan                    String?               @default("starter") @db.VarChar(20)
  role                       String                @default("user") @db.VarChar(20)
  signup_method              String?               @db.VarChar(50)
  signup_completed_at        DateTime?             @db.Timestamp(6)
  first_login_at             DateTime?             @db.Timestamp(6)
  content                    content[]
  marketing_campaigns        marketing_campaigns[]
  oauth_accounts             oauth_accounts[]
  subscriptions              subscriptions[]
  transactions               transactions[]
  user_stats                 user_stats?
  usage_logs                 UsageLog[]
  monthly_charges            MonthlyCharge[]
  ai_insights                AIInsight[]
  accounts                   Account[]
  sessions                   Session[]

  @@index([onboarding_completed], map: "idx_users_onboarding_completed")
  @@index([role], map: "idx_users_role")
  @@index([signup_method], map: "idx_users_signup_method")
}

model Account {
  id                String  @id @default(cuid())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("nextauth_accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       Int
  expires      DateTime

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("nextauth_sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@index([token])
  @@map("nextauth_verification_tokens")
}

model UsageLog {
  id           String   @id @default(cuid())
  creator      users    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId    Int
  feature      String
  agentId      String?
  model        String
  tokensInput  Int
  tokensOutput Int
  costUsd      Decimal  @db.Decimal(10, 6)
  createdAt    DateTime @default(now())

  @@index([creatorId, createdAt])
  @@map("usage_logs")
}

model MonthlyCharge {
  id                String   @id @default(cuid())
  creator           users    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId         Int
  month             DateTime
  totalTokensInput  Int
  totalTokensOutput Int
  totalCostUsd      Decimal  @db.Decimal(10, 6)
  planPrice         Decimal  @db.Decimal(10, 2)

  @@unique([creatorId, month])
  @@map("monthly_charges")
}

model AIInsight {
  id         String   @id @default(cuid())
  creator    users    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId  Int
  source     String
  type       String
  confidence Float
  data       Json
  createdAt  DateTime @default(now())

  @@index([creatorId, type, createdAt])
  @@map("ai_insights")
}

/// Signup funnel analytics tracking
/// Tracks user behavior through the signup process to identify drop-off points
model SignupAnalytics {
  id        String   @id @default(cuid())
  
  // Session tracking
  sessionId String   @unique
  
  // User info (nullable for anonymous tracking)
  userId    String?
  email     String?
  
  // Funnel tracking
  landingPage       String?
  referrer          String?
  utmSource         String?
  utmMedium         String?
  utmCampaign       String?
  
  // Events
  pageViewed        DateTime?
  formStarted       DateTime?
  methodSelected    String?   // 'email', 'google', 'apple'
  formSubmitted     DateTime?
  signupCompleted   DateTime?
  signupFailed      DateTime?
  errorCode         String?
  errorMessage      String?
  
  // Device info
  userAgent         String?
  deviceType        String?   // 'mobile', 'tablet', 'desktop'
  browser           String?
  os                String?
  
  // Performance
  timeToSubmit      Int?      // milliseconds
  timeToComplete    Int?      // milliseconds
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([email])
  @@index([sessionId])
  @@index([createdAt])
  @@index([methodSelected])
  @@map("signup_analytics")
}


// ============================================
// Automations & Offers - AI Features
// ============================================

/// Automation workflows for creators
model Automation {
  id          String   @id @default(uuid()) @db.Uuid
  userId      Int      @map("user_id")
  name        String   @db.VarChar(255)
  description String?  @db.Text
  steps       Json     // Array of AutomationStep
  status      String   @default("draft") @db.VarChar(24) // active, paused, draft
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  executions AutomationExecution[]

  @@index([userId, status], map: "idx_automation_user_status")
  @@index([userId, createdAt(sort: Desc)], map: "idx_automation_user_created")
  @@map("automations")
}

/// Execution logs for automations
model AutomationExecution {
  id            String   @id @default(uuid()) @db.Uuid
  automationId  String   @map("automation_id") @db.Uuid
  triggerType   String   @map("trigger_type") @db.VarChar(50)
  triggerData   Json     @map("trigger_data")
  status        String   @db.VarChar(24) // success, failed, partial
  stepsExecuted Int      @map("steps_executed")
  error         String?  @db.Text
  durationMs    Int      @default(0) @map("duration_ms")
  executedAt    DateTime @default(now()) @map("executed_at") @db.Timestamptz(6)

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId, executedAt(sort: Desc)], map: "idx_execution_automation")
  @@index([status], map: "idx_execution_status")
  @@map("automation_executions")
}

/// Promotional offers for creators
model Offer {
  id              String   @id @default(uuid()) @db.Uuid
  userId          Int      @map("user_id")
  name            String   @db.VarChar(255)
  description     String?  @db.Text
  discountType    String   @map("discount_type") @db.VarChar(24) // percentage, fixed, bogo
  discountValue   Float    @map("discount_value")
  originalPrice   Float?   @map("original_price")
  validFrom       DateTime @map("valid_from") @db.Timestamptz(6)
  validUntil      DateTime @map("valid_until") @db.Timestamptz(6)
  status          String   @default("draft") @db.VarChar(24) // active, expired, scheduled, draft
  targetAudience  String?  @map("target_audience") @db.VarChar(255)
  contentIds      String[] @map("content_ids")
  redemptionCount Int      @default(0) @map("redemption_count")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  redemptions OfferRedemption[]

  @@index([userId, status], map: "idx_offer_user_status")
  @@index([userId, validUntil], map: "idx_offer_user_validity")
  @@index([status, validUntil], map: "idx_offer_status_validity")
  @@map("offers")
}

/// Redemption logs for offers
model OfferRedemption {
  id         String   @id @default(uuid()) @db.Uuid
  offerId    String   @map("offer_id") @db.Uuid
  fanId      String   @map("fan_id") @db.VarChar(255)
  amount     Float
  redeemedAt DateTime @default(now()) @map("redeemed_at") @db.Timestamptz(6)

  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)

  @@index([offerId, redeemedAt(sort: Desc)], map: "idx_redemption_offer")
  @@index([fanId], map: "idx_redemption_fan")
  @@map("offer_redemptions")
}
