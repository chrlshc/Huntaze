generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ai_plan {
  id           String         @id @db.Uuid
  source       String         @db.VarChar(32)
  account_id   String         @db.VarChar(128)
  created_at   DateTime       @default(now()) @db.Timestamptz(6)
  raw          Json
  ai_plan_item ai_plan_item[]

  @@index([account_id, created_at(sort: Desc)], map: "idx_ai_plan_account_created")
}

model ai_plan_item {
  id           String    @id @db.Uuid
  plan_id      String    @db.Uuid
  platform     String    @db.VarChar(32)
  scheduled_at DateTime? @db.Timestamptz(6)
  content      Json
  status       String    @default("scheduled") @db.VarChar(24)
  ai_plan      ai_plan   @relation(fields: [plan_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([plan_id, platform], map: "idx_item_plan_platform")
  @@index([scheduled_at], map: "idx_item_scheduled")
}

model content {
  id           String    @id
  user_id      Int
  title        String
  text         String?
  type         String    @db.VarChar(50)
  platform     String    @db.VarChar(50)
  status       String    @db.VarChar(50)
  category     String?   @db.VarChar(100)
  tags         String[]
  media_ids    String[]
  scheduled_at DateTime? @db.Timestamp(6)
  published_at DateTime? @db.Timestamp(6)
  created_at   DateTime  @default(now()) @db.Timestamp(6)
  updated_at   DateTime  @default(now()) @db.Timestamp(6)
  metadata     Json?
  users        users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([user_id, platform])
  @@index([user_id, status])
}

model events_outbox {
  id             BigInt    @id @default(autoincrement())
  aggregate_type String
  aggregate_id   String
  event_type     String
  event_time     DateTime  @default(now()) @db.Timestamptz(6)
  payload        Json
  sent_at        DateTime? @db.Timestamptz(6)
}

model insight_snapshot {
  id           BigInt   @id @default(autoincrement())
  platform     String   @db.VarChar(32)
  account_id   String   @db.VarChar(128)
  period_start DateTime @db.Date
  period_end   DateTime @db.Date
  raw          Json
  created_at   DateTime @default(now()) @db.Timestamptz(6)

  @@index([account_id, platform, period_end(sort: Desc)], map: "idx_snapshot_acc_platform")
}

model insight_summary {
  id         BigInt   @id @default(autoincrement())
  platform   String   @db.VarChar(32)
  account_id String   @db.VarChar(128)
  period     String
  summary    Json
  created_at DateTime @default(now()) @db.Timestamptz(6)

  @@index([account_id, platform, created_at(sort: Desc)], map: "idx_summary_acc_platform")
}

model marketing_campaigns {
  id               String   @id
  user_id          Int
  name             String   @db.VarChar(255)
  status           String   @db.VarChar(50)
  channel          String   @db.VarChar(50)
  goal             String   @db.VarChar(50)
  audience_segment String   @db.VarChar(100)
  audience_size    Int
  message          Json
  schedule         Json?
  stats            Json?
  created_at       DateTime @default(now()) @db.Timestamp(6)
  updated_at       DateTime @default(now()) @db.Timestamp(6)
  users            users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, channel])
  @@index([user_id, status])
}

model oauth_accounts {
  id                  Int       @id @default(autoincrement())
  user_id             Int
  provider            String    @db.VarChar(50)
  provider_account_id String    @db.VarChar(255)
  access_token        String?
  refresh_token       String?
  expires_at          DateTime? @db.Timestamp(6)
  token_type          String?   @db.VarChar(50)
  scope               String?
  metadata            Json?
  created_at          DateTime  @default(now()) @db.Timestamp(6)
  updated_at          DateTime  @default(now()) @db.Timestamp(6)
  users               users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([provider, provider_account_id])
  @@index([user_id, provider])
}

model subscriptions {
  id         String    @id
  user_id    Int
  fan_id     String    @db.VarChar(255)
  platform   String    @db.VarChar(50)
  tier       String?   @db.VarChar(50)
  amount     Float
  status     String    @db.VarChar(50)
  started_at DateTime  @db.Timestamp(6)
  ends_at    DateTime? @db.Timestamp(6)
  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime  @default(now()) @db.Timestamp(6)
  users      users     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, platform])
  @@index([user_id, status])
}

model transactions {
  id         String   @id
  user_id    Int
  amount     Float
  currency   String   @default("USD") @db.VarChar(10)
  status     String   @db.VarChar(50)
  type       String   @db.VarChar(50)
  platform   String?  @db.VarChar(50)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([user_id, status])
}

model user_stats {
  id                  String   @id
  user_id             Int      @unique
  messages_sent       Int      @default(0)
  messages_trend      Float    @default(0)
  response_rate       Float    @default(0)
  response_rate_trend Float    @default(0)
  revenue             Float    @default(0)
  revenue_trend       Float    @default(0)
  active_chats        Int      @default(0)
  active_chats_trend  Float    @default(0)
  created_at          DateTime @default(now()) @db.Timestamp(6)
  updated_at          DateTime @default(now()) @db.Timestamp(6)
  users               users    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model users {
  id                         Int                   @id @default(autoincrement())
  email                      String                @unique @db.VarChar(255)
  name                       String?               @db.VarChar(255)
  password                   String?               @db.VarChar(255)
  email_verified             Boolean?              @default(false)
  email_verification_token   String?               @db.VarChar(255)
  email_verification_expires DateTime?             @db.Timestamp(6)
  created_at                 DateTime?             @default(now()) @db.Timestamp(6)
  updated_at                 DateTime?             @default(now()) @db.Timestamp(6)
  onboarding_completed       Boolean?              @default(false)
  content_types              String[]              @default([])
  goal                       String?               @db.VarChar(100)
  revenue_goal               Int?
  ai_plan                    String?               @default("starter") @db.VarChar(20)
  role                       String                @default("user") @db.VarChar(20)
  content                    content[]
  marketing_campaigns        marketing_campaigns[]
  oauth_accounts             oauth_accounts[]
  subscriptions              subscriptions[]
  transactions               transactions[]
  user_stats                 user_stats?
  usage_logs                 UsageLog[]
  monthly_charges            MonthlyCharge[]
  ai_insights                AIInsight[]

  @@index([onboarding_completed], map: "idx_users_onboarding_completed")
  @@index([role], map: "idx_users_role")
}

model UsageLog {
  id           String   @id @default(cuid())
  creator      users    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId    Int
  feature      String
  agentId      String?
  model        String
  tokensInput  Int
  tokensOutput Int
  costUsd      Decimal  @db.Decimal(10, 6)
  createdAt    DateTime @default(now())

  @@index([creatorId, createdAt])
  @@map("usage_logs")
}

model MonthlyCharge {
  id                String   @id @default(cuid())
  creator           users    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId         Int
  month             DateTime
  totalTokensInput  Int
  totalTokensOutput Int
  totalCostUsd      Decimal  @db.Decimal(10, 6)
  planPrice         Decimal  @db.Decimal(10, 2)

  @@unique([creatorId, month])
  @@map("monthly_charges")
}

model AIInsight {
  id         String   @id @default(cuid())
  creator    users    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  creatorId  Int
  source     String
  type       String
  confidence Float
  data       Json
  createdAt  DateTime @default(now())

  @@index([creatorId, type, createdAt])
  @@map("ai_insights")
}
